name: Lint

on:
   workflow_dispatch:
   pull_request:
      branches: [main]

env:
   APPLY_FIXES: all
   APPLY_FIXES_EVENT: pull_request
   APPLY_FIXES_MODE: commit

concurrency:
   group: ${{ github.ref }}-${{ github.workflow }}
   cancel-in-progress: true

jobs:
   lint:
      name: Lint
      runs-on: ubuntu-22.04
      steps:
         - name: Checkout repo
           uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

         - name: Lint
           id: ml
           uses: oxsecurity/megalinter@f8d535e8f1b5be62df8ea5c9c8548035fc298788
           env:
              VALIDATE_ALL_CODEBASE: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

         - name: Archive production artifacts
           if: ${{ success() }} || ${{ failure() }}
           uses: actions/upload-artifact@6673cd052c4cd6fcf4b4e6e60ea986c889389535
           with:
              name: Lint Report
              path: |
                 megalinter-reports
                 mega-linter.log

         - name: Create pull pequest with applied fixes
           id: cpr
           if: steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'pull_request' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository) && !contains(github.event.head_commit.message, 'skip fix')
           uses: peter-evans/create-pull-request@2b011faafdcbc9ceb11414d64d0573f37c774b04
           with:
              token: ${{ secrets.GITHUB_TOKEN }}
              commit-message: "Apply lint fixes"
              title: "Apply lint fixes"
              labels: bot
         - name: Create PR output
           if: steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'pull_request' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository) && !contains(github.event.head_commit.message, 'skip fix')
           run: |
              echo "PR: ${{ steps.cpr.outputs.pull-request-number }}"
              echo "PR URL: ${{ steps.cpr.outputs.pull-request-url }}"

         - name: Prepare commit
           if: steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'commit' && github.ref != 'refs/heads/main' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository) && !contains(github.event.head_commit.message, 'skip fix')
           run: sudo chown -Rc $UID .git/
         - name: Commit and push applied lint fixes
           if: steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'commit' && github.ref != 'refs/heads/main' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository) && !contains(github.event.head_commit.message, 'skip fix')
           uses: stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a
           with:
              branch: ${{ github.event.pull_request.head.ref || github.head_ref || github.ref }}
              commit_message: "Apply lint fixes"
